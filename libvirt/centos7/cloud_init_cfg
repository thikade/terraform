#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}
manage_etc_hosts: false
users:
   - name: hhuebler
     gecos: Hermann L. Huebler
     sudo: ALL=(ALL) NOPASSWD:ALL
     home: /home/hhuebler
     shell: /bin/bash
     plain_text_passwd: start123.
     lock_passwd: false
     ssh-authorized-keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILgucXHwYfcPHW2cMDP0poRG9TYqV+8IzEmduZmjbtrG os@hhuelinux
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDGujoB4TIzH8vvTc1Qs8dDd47ZTw7Vx7ps6Up1Ynr7M hhuebler@2innovate.at
users:
   - name: root
     ssh-authorized-keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILgucXHwYfcPHW2cMDP0poRG9TYqV+8IzEmduZmjbtrG os@hhuelinux
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDGujoB4TIzH8vvTc1Qs8dDd47ZTw7Vx7ps6Up1Ynr7M hhuebler@2innovate.at
# only cert auth via ssh (console access can still login)
ssh_pwauth: true
disable_root: false
growpart:
   mode: auto
   devices: ["/"]
   ignore_growroot_disabled: false
chpasswd:
   list: |
      root:start123.
      hhuebler:start123.
   expire: False
# Update packages
package_update: true
# Add yum repos
yum_repos:
   kubernetes:
      name: kubernetes
      baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
      enabled: true
      gpgcheck: true
      gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
   docker:
      name: docker-ce
      baseurl: https://download.docker.com/linux/centos/docker-ce.repo
      enabled: true
packages:
    - kubelet
    - kubeadm
    - kubectl
    - firewalld
    - yum-utils
    - device-mapper-persistent-data
    - lvm2
    - docker
runcmd:
   - systemctl enable kubelet
   - systemctl start kubelet
   - systemctl enable firewalld.service
   - systemctl start firewalld.service
   - systemctl enable docker
   - systemctl start docker
   - firewall-cmd --permanent --add-port=6443/tcp
   - firewall-cmd --permanent --add-port=2379-2380/tcp
   - firewall-cmd --permanent --add-port=10250/tcp
   - firewall-cmd --permanent --add-port=10251/tcp
   - firewall-cmd --permanent --add-port=10252/tcp
   - firewall-cmd --permanent --add-port=10255/tcp
   - firewall-cmd --permanent --add-port=10251/tcp
   - firewall-cmd --permanent --add-port=10255/tcp
   - firewall-cmd --reload
   - sysctl --system
   - setenforce 0
   - sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config
# write files
write_files:
   - path: /etc/hosts
     permissions: '0644'
     content: |
        #Host file
        127.0.0.1 localhost.localdomain localhost
        127.0.0.1 localhost4.localdomain4 localhost4

        # The following lines are desirable for IPv6 capable hosts
        ::1 localhost.localdomain localhost
        ::1 localhost6.localdomain6 localhost6

        # Cluster nodes
        192.168.122.132         centos7-01.hhue.at centos7-01 master-node
        192.168.122.133         centos7-02.hhue.at centos7-02 worker-node1
        192.168.122.134         centos7-03.hhue.at centos7-03 worker-node2
   - path: /root/test.txt
     permissions: '0644'
     content: |
        The quick brown fox jumped
        over the lazy dog
   - path: /etc/sysctl.d/k8s.conf
     permissions: '0644'
     content: |
        net.bridge.bridge-nf-call-ip6tables = 1
        net.bridge.bridge-nf-call-iptables = 1
####
# written to /var/log/cloud-init-output.log
final_message: "The system is finally up, after $UPTIME seconds"
